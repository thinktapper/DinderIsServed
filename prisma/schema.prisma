// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url      = env("RENDER_DB_URL")
  url      = env("LOCAL_DB_URL")
}

enum Role {
  ADMIN
  USER
  SHEPHERD
  ORGANIZER
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  email     String   @unique
  username  String   @unique
  password  String
  roles     Role[]   @default([USER])

  herds           Herd[]  @relation(name: "herds")
  shepHerds       Herd[]  @relation(name: "shepHerds")
  organizedFeasts Feast[] @relation(name: "organizer")
  votes           Vote[]

  @@unique([username, email])
  @@index([username, email])
  @@map(name: "users")
}

model Feast {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizer   User   @relation(name: "organizer", fields: [organizerId], references: [id], onDelete: Cascade)
  organizerId String
  herd        Herd   @relation(fields: [herdId], references: [id])
  herdId      String

  name     String  @db.VarChar(255)
  start    String? @db.VarChar(255)
  end      String? @db.VarChar(255)
  // end      DateTime @default(now())
  location Json
  radius   Int
  places   Place[]

  closed   Boolean? @default(false)
  winner   Place?   @relation(name: "winner", fields: [winnerId], references: [id])
  winnerId String?

  @@unique([id, organizerId])
  @@map(name: "feasts")
}

model Herd {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name       String @db.VarChar(255)
  shepherd   User   @relation(name: "shepHerds", fields: [shepherdId], references: [id], onDelete: Cascade)
  shepherdId String

  members User[]  @relation(name: "herds")
  feasts  Feast[]

  @@unique([id, shepherdId])
  @@index([id, name])
}

model Place {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  feast   Feast  @relation(fields: [feastId], references: [id], onDelete: Cascade)
  feastId String

  googleId     String
  name         String   @db.VarChar(255)
  description  String?
  price        String?
  rating       String?
  ratingsTotal String?
  stars        String?
  photos       String[]

  votes     Vote[]
  wonFeasts Feast[] @relation(name: "winner")

  @@unique([id])
  @@index([feastId, googleId])
  @@map(name: "places")
}

model Vote {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String
  place    Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  placeId  String
  voteType VoteType

  @@unique([id])
  @@map(name: "votes")
}

enum VoteType {
  YASS
  NAH
}
